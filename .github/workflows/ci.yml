name: CI

on: [push]

jobs:
  build:
    name: Build

    runs-on: ubuntu-latest

    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: '1.15'
      id: go

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Get dependencies
      run: go get -v -t -d ./...

    - name: Fetch build tools
      run: |
        go get golang.org/x/lint/golint
        go get gotest.tools/gotestsum

    - name: Build
      run: go build -v ./...

    - name: Lint
      run: golint -set_exit_status ./...

    - name: Test
      run: |
        mkdir -p tmp/test-results
        gotestsum --junitfile tmp/test-results/gotestsum-report.xml ./...

    - name: Upload test results to BuildPulse for flaky test detection -- Inception! ðŸ¤¯
      if: '!cancelled()' # Run this step even when the tests fail. Skip if the workflow is cancelled.
      env:
        BUILDPULSE_ACCESS_KEY_ID: ${{ secrets.BUILDPULSE_ACCESS_KEY_ID }}
        BUILDPULSE_SECRET_ACCESS_KEY: ${{ secrets.BUILDPULSE_SECRET_ACCESS_KEY }}
      run: |
        curl -fsSL https://github.com/buildpulse/test-reporter/releases/latest/download/test-reporter-linux-amd64 > ./buildpulse-test-reporter
        chmod +x ./buildpulse-test-reporter
        ./buildpulse-test-reporter submit tmp/test-results --account-id 68192324 --repository-id 280914963

  smoke-test:
    name: Smoke test

    runs-on: ubuntu-latest

    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: '1.15'
      id: go

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Build executable binaries
      run: ./script/build-for-release $GITHUB_SHA

    - name: Output version
      run: ./bin/test-reporter-linux-amd64 --version

    - name: Verify binary can successfully package up test results and upload them to BuildPulse
      env:
        BUILDPULSE_ACCESS_KEY_ID: ${{ secrets.BUILDPULSE_ACCESS_KEY_ID }}
        BUILDPULSE_SECRET_ACCESS_KEY: ${{ secrets.BUILDPULSE_SECRET_ACCESS_KEY }}
      run: |
        mkdir -p fake-test-results-dir
        touch fake-test-results-dir/report.xml
        ./bin/test-reporter-linux-amd64 submit fake-test-results-dir --account-id 68192324 --repository-id 280914963
